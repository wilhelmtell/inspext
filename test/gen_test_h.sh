#!/bin/bash
###############################################################################
# Copyright (C) 2010 Matan Nassau
#
# This file is part of INSPext.
#
# This program is free software: you can redistribute it and/or modify it under
# the terms of the GNU General Public License as published by the Free Software
# Foundation, either version 3 of the License, or (at your option) any later
# version.
#
# This program is distributed in the hope that it will be useful, but WITHOUT
# ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or FITNESS
# FOR A PARTICULAR PURPOSE.  See the GNU General Public License for more
# details.
#
# You should have received a copy of the GNU General Public License along with
# this program.  If not, see <http://www.gnu.org/licenses/>.
###############################################################################

###############################################################################
# Generate a .h file corresponding to a given .c file consisting of CU tests.
#
# CU is a unit-testing framework for C; see http://cu.danfis.cz/
###############################################################################

BIN=$0
BINNAME=$(basename $BIN)

if [ $# -eq 0 ]; then
  echo "$BINNAME:Please specify a C implementation file to process." >&2
  echo "$BINNAME:For instance, try running $BIN test_file.c" >&2
  exit -1
fi

FILENAME=$1
if [ \! -f $FILENAME -o \! -r $FILENAME ]; then
  echo "$BINNAME:Can't find regular readable file $FILENAME" >&2
  exit -1
fi

NAME=$(basename $FILENAME .c)

echo "/******************************************************************************
 * Copyright (C) 2010 Matan Nassau
 *
 * This file is part of INSPext.
 *
 * This program is free software: you can redistribute it and/or modify it
 * under the terms of the GNU General Public License as published by the Free
 * Software Foundation, either version 3 of the License, or (at your option)
 * any later version.
 *
 * This program is distributed in the hope that it will be useful, but WITHOUT
 * ANY WARRANTY; without even the implied warranty of MERCHANTABILITY or
 * FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License for
 * more details.
 *
 * You should have received a copy of the GNU General Public License along with
 * this program.  If not, see <http://www.gnu.org/licenses/>.
 *****************************************************************************/"
echo
echo "/* autogenerated code; edit at your own peril */"
echo
echo "#ifndef $(echo $NAME |tr a-z A-Z)_H_"
echo "#define $(echo $NAME |tr a-z A-Z)_H_"
echo
echo '#include "cu.h"'
echo
sed '/^TEST(/ !d; s/\s*{\?\s*$/;/;' <$FILENAME
echo
echo "TEST_SUITE($(echo $NAME |sed 's/^test_\?//i')_suite) {"
sed '/^TEST(/ !d; s/^/    /; s/TEST/TEST_ADD/; s/\s*{\?\s*$/,/;' <$FILENAME
echo "    TEST_SUITE_CLOSURE"
echo "};"
echo
echo "#endif /* $(echo $NAME |tr a-z A-Z)_H_ */"
